#!/bin/sh
#
# Refresh the site's content
#

umask 0002

if [ $(hostname) = istlab ] ; then
  BASE=/home/dds/web/balab
  mkdir $BASE/new
  chgrp iweb $BASE/new
else
  BASE=balab
  mkdir $BASE/new
fi

chmod 2775 $BASE/new
pelican content/ --output=$BASE/new

#Sanity check
test $(stat -c %s $BASE/new/category/members.html) -gt 20000 || { echo "[Error] File $BASE/new/category/members.html appears truncated, please check members file and update again!"; exit 1; }
test $(stat -c %s $BASE/new/category/software.html) -gt 7000 || { echo "[Error] File $BASE/new/category/software.html appears truncated, please check software file and update again!"; exit 1; }
test $(stat -c %s $BASE/new/category/projects.html) -gt 10000 || { echo "[Error] File $BASE/new/category/projects.html appears truncated, please check projects file and update again!"; exit 1; }
test $(stat -c %s $BASE/new/category/alumni.html) -gt 5000 || { echo "[Error] File $BASE/new/category/alumni.html appears truncated, please check alumni file and update again!"; exit 1; }
test $(stat -c %s $BASE/new/category/yearly-reports.html) -gt 5000 || { echo "[Error] File $BASE/new/category/yearly-reports.html appears truncated, please check yearly-reports file and update again!"; exit 1; }

test -d $BASE/current && mv $BASE/current $BASE/old
mv $BASE/new $BASE/current
rm -rf $BASE/old
